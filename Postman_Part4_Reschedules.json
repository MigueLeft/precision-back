{
  "info": {
    "name": "NestJS Medical System API - Part 4: Reschedules",
    "description": "Comprehensive testing collection for the Reschedules module. Includes appointment rescheduling workflows, approval processes, state transitions, and business logic validation for medical appointment management.",
    "version": "1.0.0",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{authToken}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000",
      "type": "string"
    },
    {
      "key": "authToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "rescheduleId",
      "value": "",
      "type": "string"
    },
    {
      "key": "testAppointmentId",
      "value": "",
      "type": "string"
    },
    {
      "key": "testPatientId",
      "value": "",
      "type": "string"
    },
    {
      "key": "testMedicId",
      "value": "",
      "type": "string"
    },
    {
      "key": "testUserId",
      "value": "",
      "type": "string"
    },
    {
      "key": "originalDateTime",
      "value": "",
      "type": "string"
    },
    {
      "key": "newDateTime",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Reschedules Module",
      "item": [
        {
          "name": "Create Reschedule Request",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Set test dates for rescheduling",
                  "const now = new Date();",
                  "const originalDate = new Date(now.getTime() + (24 * 60 * 60 * 1000)); // Tomorrow",
                  "const newDate = new Date(now.getTime() + (3 * 24 * 60 * 60 * 1000)); // 3 days from now",
                  "",
                  "pm.collectionVariables.set('originalDateTime', originalDate.toISOString());",
                  "pm.collectionVariables.set('newDateTime', newDate.toISOString());"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response has success wrapper', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', true);",
                  "    pm.expect(jsonData).to.have.property('data');",
                  "    pm.expect(jsonData).to.have.property('timestamp');",
                  "});",
                  "",
                  "pm.test('Reschedule created with correct data', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule).to.have.property('id');",
                  "    pm.expect(reschedule).to.have.property('appointmentId', pm.collectionVariables.get('testAppointmentId'));",
                  "    pm.expect(reschedule).to.have.property('status', 'PENDING');",
                  "    pm.expect(reschedule).to.have.property('requestedBy', pm.collectionVariables.get('testUserId'));",
                  "    pm.expect(reschedule).to.have.property('reason', 'PACIENTE_SOLICITO');",
                  "    pm.expect(reschedule).to.have.property('originalDateTime');",
                  "    pm.expect(reschedule).to.have.property('newDateTime');",
                  "    pm.expect(reschedule).to.have.property('isActive', true);",
                  "    ",
                  "    // Store reschedule ID for subsequent tests",
                  "    pm.collectionVariables.set('rescheduleId', reschedule.id);",
                  "});",
                  "",
                  "pm.test('Date fields are valid', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    const originalDate = new Date(reschedule.originalDateTime);",
                  "    const newDate = new Date(reschedule.newDateTime);",
                  "    ",
                  "    pm.expect(originalDate.getTime()).to.be.lessThan(newDate.getTime());",
                  "    pm.expect(newDate.getTime()).to.be.greaterThan(Date.now());",
                  "});",
                  "",
                  "pm.test('Reschedule reason is valid enum', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const validReasons = ['PACIENTE_SOLICITO', 'MEDICO_NO_DISPONIBLE', 'EMERGENCIA_MEDICA', 'PROBLEMA_TECNICO', 'CANCELACION_HOSPITAL', 'OTRO'];",
                  "    pm.expect(validReasons).to.include(jsonData.data.reason);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"appointmentId\": \"{{testAppointmentId}}\",\n  \"originalDateTime\": \"{{originalDateTime}}\",\n  \"newDateTime\": \"{{newDateTime}}\",\n  \"reason\": \"PACIENTE_SOLICITO\",\n  \"requestedBy\": \"{{testUserId}}\",\n  \"notes\": \"Paciente solicita reprogramar cita debido a conflicto laboral. Prefiere fecha en horario vespertino.\",\n  \"priority\": \"MEDIA\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"]
            }
          }
        },
        {
          "name": "Create High Priority Reschedule",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Create urgent reschedule request",
                  "const now = new Date();",
                  "const urgentOriginal = new Date(now.getTime() + (2 * 60 * 60 * 1000)); // 2 hours from now",
                  "const urgentNew = new Date(now.getTime() + (48 * 60 * 60 * 1000)); // 48 hours from now",
                  "",
                  "pm.collectionVariables.set('urgentOriginalDateTime', urgentOriginal.toISOString());",
                  "pm.collectionVariables.set('urgentNewDateTime', urgentNew.toISOString());"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('High priority reschedule created', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule.priority).to.equal('ALTA');",
                  "    pm.expect(reschedule.reason).to.equal('EMERGENCIA_MEDICA');",
                  "    pm.expect(reschedule.status).to.equal('PENDING');",
                  "    ",
                  "    pm.collectionVariables.set('urgentRescheduleId', reschedule.id);",
                  "});",
                  "",
                  "pm.test('Creation date is recent', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const createdAt = new Date(jsonData.data.createdAt);",
                  "    const now = new Date();",
                  "    const diffInMinutes = (now - createdAt) / (1000 * 60);",
                  "    pm.expect(diffInMinutes).to.be.lessThan(2);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"appointmentId\": \"{{testAppointmentId}}\",\n  \"originalDateTime\": \"{{urgentOriginalDateTime}}\",\n  \"newDateTime\": \"{{urgentNewDateTime}}\",\n  \"reason\": \"EMERGENCIA_MEDICA\",\n  \"requestedBy\": \"{{testUserId}}\",\n  \"notes\": \"Emergencia médica familiar. Paciente necesita reprogramar urgentemente la cita. Disponible cualquier día de la próxima semana.\",\n  \"priority\": \"ALTA\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"]
            }
          }
        },
        {
          "name": "Get All Reschedules",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has pagination structure', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data).to.have.property('items');",
                  "    pm.expect(jsonData.data).to.have.property('meta');",
                  "    pm.expect(jsonData.data.meta).to.have.property('totalItems');",
                  "    pm.expect(jsonData.data.meta).to.have.property('itemCount');",
                  "    pm.expect(jsonData.data.meta).to.have.property('totalPages');",
                  "});",
                  "",
                  "pm.test('Items contain reschedule data', function () {",
                  "    const jsonData = pm.response.json();",
                  "    if (jsonData.data.items.length > 0) {",
                  "        const reschedule = jsonData.data.items[0];",
                  "        pm.expect(reschedule).to.have.property('id');",
                  "        pm.expect(reschedule).to.have.property('status');",
                  "        pm.expect(reschedule).to.have.property('reason');",
                  "        pm.expect(reschedule).to.have.property('priority');",
                  "        pm.expect(reschedule).to.have.property('appointment');",
                  "        pm.expect(reschedule).to.have.property('requestedByUser');",
                  "    }",
                  "});",
                  "",
                  "pm.test('Filters work correctly', function () {",
                  "    const jsonData = pm.response.json();",
                  "    jsonData.data.items.forEach(reschedule => {",
                  "        pm.expect(reschedule.status).to.equal('PENDING');",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules?page=1&limit=10&status=PENDING&priority=MEDIA",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "10"
                },
                {
                  "key": "status",
                  "value": "PENDING"
                },
                {
                  "key": "priority",
                  "value": "MEDIA"
                }
              ]
            }
          }
        },
        {
          "name": "Get Reschedule by ID",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Returns correct reschedule with relationships', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule.id).to.equal(pm.collectionVariables.get('rescheduleId'));",
                  "    pm.expect(reschedule).to.have.property('appointment');",
                  "    pm.expect(reschedule.appointment).to.have.property('patient');",
                  "    pm.expect(reschedule.appointment).to.have.property('medic');",
                  "    pm.expect(reschedule).to.have.property('requestedByUser');",
                  "});",
                  "",
                  "pm.test('Contains all reschedule details', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule.reason).to.equal('PACIENTE_SOLICITO');",
                  "    pm.expect(reschedule.priority).to.equal('MEDIA');",
                  "    pm.expect(reschedule.status).to.equal('PENDING');",
                  "    pm.expect(reschedule.notes).to.include('conflicto laboral');",
                  "    pm.expect(reschedule).to.have.property('originalDateTime');",
                  "    pm.expect(reschedule).to.have.property('newDateTime');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules/{{rescheduleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "{{rescheduleId}}"]
            }
          }
        },
        {
          "name": "Get Reschedules by Appointment",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('All reschedules belong to appointment', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const expectedAppointmentId = pm.collectionVariables.get('testAppointmentId');",
                  "    jsonData.data.forEach(reschedule => {",
                  "        pm.expect(reschedule.appointmentId).to.equal(expectedAppointmentId);",
                  "    });",
                  "});",
                  "",
                  "pm.test('Reschedules are ordered by creation date', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedules = jsonData.data;",
                  "    for (let i = 0; i < reschedules.length - 1; i++) {",
                  "        const current = new Date(reschedules[i].createdAt);",
                  "        const next = new Date(reschedules[i + 1].createdAt);",
                  "        pm.expect(current.getTime()).to.be.at.most(next.getTime());",
                  "    }",
                  "});",
                  "",
                  "pm.test('Contains our created reschedules', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const rescheduleId = pm.collectionVariables.get('rescheduleId');",
                  "    const found = jsonData.data.some(item => item.id === rescheduleId);",
                  "    pm.expect(found).to.be.true;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules/appointment/{{testAppointmentId}}",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "appointment", "{{testAppointmentId}}"]
            }
          }
        },
        {
          "name": "Update Reschedule",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Reschedule updated successfully', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule.priority).to.equal('ALTA');",
                  "    pm.expect(reschedule.notes).to.include('Actualización');",
                  "});",
                  "",
                  "pm.test('Updated timestamp is recent', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const updatedAt = new Date(jsonData.data.updatedAt);",
                  "    const now = new Date();",
                  "    const diffInMinutes = (now - updatedAt) / (1000 * 60);",
                  "    pm.expect(diffInMinutes).to.be.lessThan(2);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"priority\": \"ALTA\",\n  \"notes\": \"Actualización: Paciente enfatizó la urgencia de la reprogramación. Situación laboral crítica que requiere atención prioritaria.\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules/{{rescheduleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "{{rescheduleId}}"]
            }
          }
        },
        {
          "name": "Approve Reschedule",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Reschedule approved successfully', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule.status).to.equal('APPROVED');",
                  "    pm.expect(reschedule).to.have.property('approvedBy', pm.collectionVariables.get('testUserId'));",
                  "    pm.expect(reschedule).to.have.property('approvedAt');",
                  "});",
                  "",
                  "pm.test('Approval timestamp is recent', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const approvedAt = new Date(jsonData.data.approvedAt);",
                  "    const now = new Date();",
                  "    const diffInMinutes = (now - approvedAt) / (1000 * 60);",
                  "    pm.expect(diffInMinutes).to.be.lessThan(2);",
                  "});",
                  "",
                  "pm.test('Status transition is valid', function () {",
                  "    const jsonData = pm.response.json();",
                  "    // Valid transitions: PENDING → APPROVED",
                  "    pm.expect(['APPROVED']).to.include(jsonData.data.status);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"approvedBy\": \"{{testUserId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules/{{rescheduleId}}/approve",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "{{rescheduleId}}", "approve"]
            }
          }
        },
        {
          "name": "Create Reschedule for Rejection",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Create reschedule that will be rejected",
                  "const now = new Date();",
                  "const rejectOriginal = new Date(now.getTime() + (6 * 60 * 60 * 1000)); // 6 hours from now",
                  "const rejectNew = new Date(now.getTime() + (72 * 60 * 60 * 1000)); // 72 hours from now",
                  "",
                  "pm.collectionVariables.set('rejectOriginalDateTime', rejectOriginal.toISOString());",
                  "pm.collectionVariables.set('rejectNewDateTime', rejectNew.toISOString());"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "const jsonData = pm.response.json();",
                  "pm.collectionVariables.set('rescheduleToRejectId', jsonData.data.id);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"appointmentId\": \"{{testAppointmentId}}\",\n  \"originalDateTime\": \"{{rejectOriginalDateTime}}\",\n  \"newDateTime\": \"{{rejectNewDateTime}}\",\n  \"reason\": \"OTRO\",\n  \"requestedBy\": \"{{testUserId}}\",\n  \"notes\": \"Solicitud de reprogramación que será rechazada por conflicto de horarios con otros pacientes.\",\n  \"priority\": \"BAJA\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"]
            }
          }
        },
        {
          "name": "Reject Reschedule",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Reschedule rejected successfully', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule.status).to.equal('REJECTED');",
                  "    pm.expect(reschedule).to.have.property('rejectedBy', pm.collectionVariables.get('testUserId'));",
                  "    pm.expect(reschedule).to.have.property('rejectedAt');",
                  "    pm.expect(reschedule).to.have.property('rejectionReason');",
                  "});",
                  "",
                  "pm.test('Rejection details are correct', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const reschedule = jsonData.data;",
                  "    ",
                  "    pm.expect(reschedule.rejectionReason).to.include('conflicto de horarios');",
                  "});",
                  "",
                  "pm.test('Rejection timestamp is recent', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const rejectedAt = new Date(jsonData.data.rejectedAt);",
                  "    const now = new Date();",
                  "    const diffInMinutes = (now - rejectedAt) / (1000 * 60);",
                  "    pm.expect(diffInMinutes).to.be.lessThan(2);",
                  "});",
                  "",
                  "pm.test('Status transition is valid', function () {",
                  "    const jsonData = pm.response.json();",
                  "    // Valid transitions: PENDING → REJECTED",
                  "    pm.expect(['REJECTED']).to.include(jsonData.data.status);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"rejectedBy\": \"{{testUserId}}\",\n  \"rejectionReason\": \"La nueva fecha solicitada presenta conflicto de horarios con otros pacientes. Se sugiere buscar horarios alternativos en la misma semana.\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules/{{rescheduleToRejectId}}/reject",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "{{rescheduleToRejectId}}", "reject"]
            }
          }
        },
        {
          "name": "Create Reschedule - Invalid Appointment (Error Case)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 404', function () {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test('Error message indicates appointment not found', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.false;",
                  "    pm.expect(jsonData.message).to.include('Cita no encontrada');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"appointmentId\": \"clm000nonexistent000\",\n  \"originalDateTime\": \"{{originalDateTime}}\",\n  \"newDateTime\": \"{{newDateTime}}\",\n  \"reason\": \"PACIENTE_SOLICITO\",\n  \"requestedBy\": \"{{testUserId}}\",\n  \"notes\": \"Test error case with non-existent appointment\",\n  \"priority\": \"MEDIA\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"]
            }
          }
        },
        {
          "name": "Create Reschedule - Invalid Date Range (Error Case)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error message indicates invalid date range', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.false;",
                  "    pm.expect(jsonData.message).to.include('fecha');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"appointmentId\": \"{{testAppointmentId}}\",\n  \"originalDateTime\": \"{{newDateTime}}\",\n  \"newDateTime\": \"{{originalDateTime}}\",\n  \"reason\": \"PACIENTE_SOLICITO\",\n  \"requestedBy\": \"{{testUserId}}\",\n  \"notes\": \"Test error case with invalid date range (new date before original)\",\n  \"priority\": \"MEDIA\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"]
            }
          }
        },
        {
          "name": "Approve Already Processed Reschedule (Error Case)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error message indicates already processed', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.false;",
                  "    pm.expect(jsonData.message).to.include('ya fue procesada');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"approvedBy\": \"{{testUserId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/reschedules/{{rescheduleId}}/approve",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "{{rescheduleId}}", "approve"]
            }
          }
        },
        {
          "name": "Get Reschedule - Not Found (Error Case)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 404', function () {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test('Error message indicates reschedule not found', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.false;",
                  "    pm.expect(jsonData.message).to.include('Reprogramación no encontrada');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules/clm000nonexistent000",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "clm000nonexistent000"]
            }
          }
        },
        {
          "name": "Delete Reschedule (Soft Delete)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 204', function () {",
                  "    pm.response.to.have.status(204);",
                  "});",
                  "",
                  "pm.test('Response body is empty for soft delete', function () {",
                  "    pm.expect(pm.response.text()).to.be.empty;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules/{{rescheduleToRejectId}}",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules", "{{rescheduleToRejectId}}"]
            }
          }
        }
      ]
    },
    {
      "name": "State Transition Tests",
      "item": [
        {
          "name": "Test Valid State Transitions",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Create reschedule for state transition testing",
                  "const now = new Date();",
                  "const stateOriginal = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // 8 hours from now",
                  "const stateNew = new Date(now.getTime() + (96 * 60 * 60 * 1000)); // 96 hours from now",
                  "",
                  "pm.collectionVariables.set('stateOriginalDateTime', stateOriginal.toISOString());",
                  "pm.collectionVariables.set('stateNewDateTime', stateNew.toISOString());"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "console.log('Valid Reschedule State Transitions:');",
                  "console.log('1. PENDING (initial state)');",
                  "console.log('2. PENDING → APPROVED (by authorized user)');",
                  "console.log('3. PENDING → REJECTED (with reason)');",
                  "console.log('4. APPROVED → COMPLETED (when appointment is rescheduled)');",
                  "console.log('5. Any state → CANCELLED (by requester or admin)');",
                  "",
                  "console.log('Business Rules Validated:');",
                  "console.log('- Only PENDING reschedules can be approved/rejected');",
                  "console.log('- Approval requires authorized user');",
                  "console.log('- Rejection requires reason');",
                  "console.log('- New date must be after original date');",
                  "console.log('- Priority affects processing order');",
                  "",
                  "console.log('Priority Levels:');",
                  "console.log('- BAJA: Regular requests, 48-72h processing');",
                  "console.log('- MEDIA: Standard requests, 24-48h processing');",
                  "console.log('- ALTA: Urgent requests, 12-24h processing');",
                  "console.log('- CRITICA: Emergency requests, immediate processing');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules?status=PENDING&priority=ALTA",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"],
              "query": [
                {
                  "key": "status",
                  "value": "PENDING"
                },
                {
                  "key": "priority",
                  "value": "ALTA"
                }
              ]
            }
          }
        },
        {
          "name": "Test Reschedule Reasons Validation",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "console.log('Valid Reschedule Reasons:');",
                  "console.log('- PACIENTE_SOLICITO: Patient requested change');",
                  "console.log('- MEDICO_NO_DISPONIBLE: Doctor unavailable');",
                  "console.log('- EMERGENCIA_MEDICA: Medical emergency');",
                  "console.log('- PROBLEMA_TECNICO: Technical issues');",
                  "console.log('- CANCELACION_HOSPITAL: Hospital cancellation');",
                  "console.log('- OTRO: Other reasons (requires detailed notes)');",
                  "",
                  "console.log('Reason-Priority Mapping:');",
                  "console.log('- EMERGENCIA_MEDICA → CRITICA/ALTA priority');",
                  "console.log('- MEDICO_NO_DISPONIBLE → ALTA/MEDIA priority');",
                  "console.log('- PACIENTE_SOLICITO → MEDIA/BAJA priority');",
                  "console.log('- Other reasons → Context-dependent priority');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules?reason=EMERGENCIA_MEDICA",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"],
              "query": [
                {
                  "key": "reason",
                  "value": "EMERGENCIA_MEDICA"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Integration Workflows",
      "item": [
        {
          "name": "Complete Reschedule Approval Workflow",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "console.log('Complete Reschedule Approval Workflow:');",
                  "console.log('1. Patient/Staff creates reschedule request (PENDING)');",
                  "console.log('2. System validates appointment exists and dates are valid');",
                  "console.log('3. Request enters approval queue based on priority');",
                  "console.log('4. Authorized user reviews and approves/rejects');",
                  "console.log('5. If approved: Original appointment is updated');",
                  "console.log('6. If rejected: Alternative options are provided');",
                  "console.log('7. Patient is notified of the decision');",
                  "console.log('8. Follow-up actions are triggered if needed');",
                  "",
                  "console.log('Integration Points:');",
                  "console.log('- Appointments module (for date/time validation)');",
                  "console.log('- Users module (for authorization checks)');",
                  "console.log('- Notifications (for patient/staff updates)');",
                  "console.log('- Audit logs (for tracking changes)');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules?status=APPROVED&page=1&limit=5",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"],
              "query": [
                {
                  "key": "status",
                  "value": "APPROVED"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "5"
                }
              ]
            }
          }
        },
        {
          "name": "Emergency Reschedule Priority Workflow",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "console.log('Emergency Reschedule Priority Workflow:');",
                  "console.log('1. Emergency situation creates CRITICA priority reschedule');",
                  "console.log('2. System immediately flags for urgent processing');",
                  "console.log('3. Automated notifications sent to supervisors');",
                  "console.log('4. Alternative slots are automatically suggested');",
                  "console.log('5. Fast-track approval process initiated');",
                  "console.log('6. Patient contacted within 15 minutes of approval');",
                  "console.log('7. Original appointment slot released for others');",
                  "console.log('8. Emergency response metrics are tracked');",
                  "",
                  "console.log('Escalation Matrix:');",
                  "console.log('- CRITICA: < 15 min response, supervisor notification');",
                  "console.log('- ALTA: < 2 hours response, manager awareness');",
                  "console.log('- MEDIA: < 24 hours response, standard process');",
                  "console.log('- BAJA: < 72 hours response, batch processing');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/reschedules?priority=CRITICA&status=PENDING",
              "host": ["{{baseUrl}}"],
              "path": ["reschedules"],
              "query": [
                {
                  "key": "priority",
                  "value": "CRITICA"
                },
                {
                  "key": "status",
                  "value": "PENDING"
                }
              ]
            }
          }
        }
      ]
    }
  ]
}